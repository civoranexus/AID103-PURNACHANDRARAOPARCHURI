<!-- CropGuard AI - Weather Integration Module -->
<!-- Add this to index.html in appropriate section -->

<section id="weather-section" class="weather-module" style="display:none;">
    <div class="weather-container">
        <!-- Weather Header -->
        <div class="weather-header">
            <h2>üå§Ô∏è Weather & Disease Risk Analysis</h2>
            <button id="refreshWeatherBtn" class="btn btn-secondary" title="Refresh weather data">
                <span>üîÑ Refresh</span>
            </button>
        </div>

        <!-- Current Weather Card -->
        <div class="weather-card current-weather">
            <div class="weather-main">
                <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                <div class="weather-info">
                    <div class="temp-display">
                        <span id="temperature" class="temp">--¬∞C</span>
                        <span id="weatherCondition" class="condition">Loading...</span>
                    </div>
                    <div class="location-info">
                        <small id="weatherLocation">Current Location</small>
                    </div>
                </div>
            </div>

            <div class="weather-details">
                <div class="detail-item">
                    <span class="icon">üíß</span>
                    <div>
                        <label>Humidity</label>
                        <span id="humidity" class="value">--%</span>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="icon">üí®</span>
                    <div>
                        <label>Wind Speed</label>
                        <span id="windSpeed" class="value">-- km/h</span>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="icon">üåßÔ∏è</span>
                    <div>
                        <label>Rainfall</label>
                        <span id="rainfall" class="value">-- mm</span>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="icon">üß™</span>
                    <div>
                        <label>Pressure</label>
                        <span id="pressure" class="value">-- mb</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disease Risk Assessment -->
        <div class="disease-risk-card">
            <h3>‚ö†Ô∏è Disease Risk Level</h3>
            <div class="risk-meter">
                <div id="riskLevel" class="risk-indicator green">
                    <span class="risk-text">LOW RISK</span>
                    <span class="risk-percentage">25%</span>
                </div>
            </div>
            <div class="risk-details">
                <div id="riskFactors" class="risk-factors">
                    <p class="factor-item">‚úì Temperature optimal for growth</p>
                    <p class="factor-item">‚úì Humidity levels normal</p>
                    <p class="factor-item">‚úì Rainfall within expected range</p>
                </div>
            </div>
        </div>

        <!-- Crop-Specific Risk Warnings -->
        <div class="crop-risk-warnings">
            <h3>üö® Crop-Specific Risks</h3>
            <div id="riskWarnings" class="warnings-list">
                <!-- Dynamically populated with warnings -->
                <div class="warning-placeholder">
                    <p>‚è≥ Loading risk analysis...</p>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="weather-recommendations">
            <h3>‚úÖ Recommended Actions</h3>
            <div id="weatherRecommendations" class="recommendations-list">
                <div class="recommendation-item">
                    <span class="action-icon">üíß</span>
                    <span class="action-text">Monitor soil moisture - current humidity suggests potential for disease</span>
                    <button class="btn btn-small">Mark Done</button>
                </div>
                <div class="recommendation-item">
                    <span class="action-icon">üîç</span>
                    <span class="action-text">Inspect crops for early disease symptoms</span>
                    <button class="btn btn-small">Mark Done</button>
                </div>
                <div class="recommendation-item">
                    <span class="action-icon">üõ°Ô∏è</span>
                    <span class="action-text">Apply preventive fungicide if risk increases</span>
                    <button class="btn btn-small">Mark Done</button>
                </div>
            </div>
        </div>

        <!-- 7-Day Forecast -->
        <div class="forecast-section">
            <h3>üìÖ 7-Day Weather Forecast</h3>
            <div id="forecastContainer" class="forecast-grid">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Historical Data -->
        <div class="historical-data">
            <h3>üìä Weather Trends (Last 7 Days)</h3>
            <div class="trend-chart">
                <canvas id="weatherTrendChart"></canvas>
                <p class="chart-note">Temperature and humidity trends for your farm</p>
            </div>
        </div>

        <!-- Alert Configuration -->
        <div class="alert-config">
            <h3>üîî Weather Alerts Configuration</h3>
            <div class="config-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="highTempAlert" checked>
                    <span>Alert when temperature > 35¬∞C</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="highHumidityAlert" checked>
                    <span>Alert when humidity > 80%</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="rainAlert" checked>
                    <span>Alert when rainfall > 20mm</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="frostAlert" checked>
                    <span>Alert for frost risk</span>
                </label>
            </div>
            <button id="saveAlertConfig" class="btn btn-primary" style="margin-top: 10px;">
                Save Alert Settings
            </button>
        </div>
    </div>
</section>

<!-- Embedded CSS for Weather Module -->
<style>
/* Weather Module Styles */
.weather-module {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.weather-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 0 10px;
}

.weather-header h2 {
    margin: 0;
    color: #1B9AAA;
    font-size: 24px;
}

/* Current Weather Card */
.weather-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.weather-main {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
}

.weather-icon {
    font-size: 64px;
    line-height: 1;
}

.weather-info {
    flex: 1;
}

.temp-display {
    display: flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 5px;
}

.temp {
    font-size: 36px;
    font-weight: bold;
    color: #1B9AAA;
}

.condition {
    font-size: 18px;
    color: #555;
}

.location-info small {
    color: #888;
    font-size: 14px;
}

.weather-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
}

.detail-item {
    display: flex;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
}

.detail-item .icon {
    font-size: 24px;
}

.detail-item label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 3px;
}

.detail-item .value {
    display: block;
    font-size: 16px;
    font-weight: bold;
    color: #1B9AAA;
}

/* Disease Risk Card */
.disease-risk-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.disease-risk-card h3 {
    margin-top: 0;
    color: #1B9AAA;
}

.risk-meter {
    margin: 20px 0;
}

.risk-indicator {
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
}

.risk-indicator.green {
    background: linear-gradient(135deg, #10B981 0%, #059669 100%);
}

.risk-indicator.yellow {
    background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
}

.risk-indicator.orange {
    background: linear-gradient(135deg, #FF8C42 0%, #FF6B35 100%);
}

.risk-indicator.red {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
}

.risk-text {
    font-size: 18px;
}

.risk-percentage {
    font-size: 24px;
}

.risk-details {
    margin-top: 15px;
}

.risk-factors {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.factor-item {
    margin: 0;
    padding: 8px;
    background: #f9f9f9;
    border-left: 3px solid #10B981;
    border-radius: 4px;
    font-size: 14px;
    color: #555;
}

/* Crop Risk Warnings */
.crop-risk-warnings {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #EF4444;
}

.crop-risk-warnings h3 {
    margin-top: 0;
    color: #EF4444;
}

.warnings-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.warning-placeholder {
    text-align: center;
    color: #888;
    padding: 20px;
}

.warning-item {
    background: #FEF2F2;
    border-left: 3px solid #EF4444;
    padding: 12px;
    border-radius: 4px;
    color: #DC2626;
    font-size: 14px;
}

/* Recommendations */
.weather-recommendations {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.weather-recommendations h3 {
    margin-top: 0;
    color: #1B9AAA;
}

.recommendations-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.recommendation-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f0fdf4;
    border-left: 3px solid #10B981;
    border-radius: 4px;
}

.action-icon {
    font-size: 20px;
    flex-shrink: 0;
}

.action-text {
    flex: 1;
    font-size: 14px;
    color: #555;
}

/* Forecast Section */
.forecast-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.forecast-section h3 {
    margin-top: 0;
    color: #1B9AAA;
}

.forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
}

.forecast-item {
    text-align: center;
    padding: 12px;
    background: #f9f9f9;
    border-radius: 8px;
}

.forecast-day {
    font-size: 12px;
    color: #888;
    margin-bottom: 5px;
}

.forecast-icon {
    font-size: 32px;
    margin: 5px 0;
}

.forecast-temp {
    font-weight: bold;
    color: #1B9AAA;
    font-size: 14px;
}

/* Historical Data */
.historical-data {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.historical-data h3 {
    margin-top: 0;
    color: #1B9AAA;
}

.trend-chart {
    position: relative;
    height: 250px;
    margin: 20px 0;
}

.chart-note {
    text-align: center;
    color: #888;
    font-size: 12px;
    margin-top: 10px;
}

/* Alert Configuration */
.alert-config {
    background: white;
    border-radius: 12px;
    padding: 20px;
}

.alert-config h3 {
    margin-top: 0;
    color: #1B9AAA;
}

.config-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-size: 14px;
}

.checkbox-label input {
    cursor: pointer;
    width: 18px;
    height: 18px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .weather-main {
        flex-direction: column;
        text-align: center;
    }

    .weather-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }

    .forecast-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    }

    .weather-details {
        grid-template-columns: repeat(2, 1fr);
    }

    .recommendation-item {
        flex-direction: column;
        align-items: flex-start;
    }
}

@media (max-width: 480px) {
    .weather-module {
        padding: 15px;
    }

    .temp {
        font-size: 28px;
    }

    .forecast-grid {
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
    }

    .weather-details {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .detail-item {
        padding: 8px;
        font-size: 13px;
    }
}

/* Animation */
@keyframes riskPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.risk-indicator.red {
    animation: riskPulse 2s infinite;
}

/* Loading state */
.weather-loading {
    opacity: 0.6;
    pointer-events: none;
}

.weather-loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 30px;
    height: 30px;
    margin: -15px 0 0 -15px;
    border: 3px solid #f0f0f0;
    border-top-color: #1B9AAA;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- JavaScript for Weather Module -->
<script>
/**
 * Weather Module - Enhanced version with API integration
 * Works with CropGuard API for weather data and disease risk assessment
 */

class WeatherModule {
    constructor() {
        this.currentWeatherData = null;
        this.forecastData = null;
        this.setupElements();
        this.setupEventListeners();
    }

    setupElements() {
        this.elements = {
            section: document.getElementById('weather-section'),
            refreshBtn: document.getElementById('refreshWeatherBtn'),
            temp: document.getElementById('temperature'),
            condition: document.getElementById('weatherCondition'),
            humidity: document.getElementById('humidity'),
            windSpeed: document.getElementById('windSpeed'),
            rainfall: document.getElementById('rainfall'),
            pressure: document.getElementById('pressure'),
            riskLevel: document.getElementById('riskLevel'),
            riskFactors: document.getElementById('riskFactors'),
            warnings: document.getElementById('riskWarnings'),
            recommendations: document.getElementById('weatherRecommendations'),
            forecast: document.getElementById('forecastContainer'),
            saveAlertBtn: document.getElementById('saveAlertConfig')
        };
    }

    setupEventListeners() {
        if (this.elements.refreshBtn) {
            this.elements.refreshBtn.addEventListener('click', () => this.loadWeatherData());
        }
        if (this.elements.saveAlertBtn) {
            this.elements.saveAlertBtn.addEventListener('click', () => this.saveAlertConfig());
        }
    }

    /**
     * Load weather data from API
     */
    async loadWeatherData() {
        try {
            if (!state.currentFarm.id) {
                showAlert('Please select a farm first', 'warning');
                return;
            }

            this.elements.section.style.display = 'block';
            this.elements.section.classList.add('weather-loading');

            // Fetch weather from backend
            const weather = await cropGuardAPI.fetchWeatherData(state.currentFarm.id);

            this.currentWeatherData = weather;
            this.renderWeatherData(weather);
            this.assessDiseaseRisk(weather);
            this.generateRecommendations(weather);

            this.elements.section.classList.remove('weather-loading');
            showAlert('Weather data updated successfully', 'success');
        } catch (error) {
            console.error('Weather load failed:', error);
            showAlert(`Weather update failed: ${error.message}`, 'error');
            this.elements.section.classList.remove('weather-loading');
        }
    }

    /**
     * Display weather data on UI
     */
    renderWeatherData(weather) {
        this.elements.temp.textContent = `${Math.round(weather.temperature)}¬∞C`;
        this.elements.condition.textContent = weather.condition || 'Partly Cloudy';
        this.elements.humidity.textContent = `${weather.humidity}%`;
        this.elements.windSpeed.textContent = `${weather.wind_speed} km/h`;
        this.elements.rainfall.textContent = `${weather.rainfall} mm`;
        this.elements.pressure.textContent = `${weather.pressure} mb`;

        // Update weather icon
        this.updateWeatherIcon(weather.condition);
    }

    /**
     * Update weather icon based on condition
     */
    updateWeatherIcon(condition) {
        const iconMap = {
            'Sunny': '‚òÄÔ∏è',
            'Cloudy': '‚òÅÔ∏è',
            'Rainy': 'üåßÔ∏è',
            'Thunderstorm': '‚õàÔ∏è',
            'Foggy': 'üå´Ô∏è',
            'Snowy': '‚ùÑÔ∏è',
            'Partly Cloudy': 'üå§Ô∏è'
        };
        document.getElementById('weatherIcon').textContent = iconMap[condition] || 'üå§Ô∏è';
    }

    /**
     * Assess disease risk based on weather
     */
    assessDiseaseRisk(weather) {
        let riskScore = 0;
        const factors = [];

        // Temperature risk (20-28¬∞C is optimal for fungal diseases)
        if (weather.temperature >= 20 && weather.temperature <= 28) {
            riskScore += 25;
            factors.push('‚ö†Ô∏è Temperature favorable for fungal diseases');
        } else if (weather.temperature < 10 || weather.temperature > 35) {
            factors.push('‚úì Temperature unfavorable for most diseases');
        } else {
            factors.push('~ Moderate temperature for disease spread');
            riskScore += 10;
        }

        // Humidity risk (>80% increases fungal disease risk)
        if (weather.humidity > 80) {
            riskScore += 30;
            factors.push('‚ö†Ô∏è High humidity - fungal disease risk increased');
        } else if (weather.humidity > 60) {
            riskScore += 15;
            factors.push('~ Moderate humidity levels');
        } else {
            factors.push('‚úì Low humidity reduces disease risk');
        }

        // Rainfall risk
        if (weather.rainfall > 10) {
            riskScore += 20;
            factors.push('‚ö†Ô∏è Heavy rainfall increases disease pressure');
        } else if (weather.rainfall > 0) {
            riskScore += 10;
            factors.push('~ Recent rainfall may favor disease');
        } else {
            factors.push('‚úì No rainfall - lower disease risk');
        }

        // Set risk level
        const riskLevel = this.elements.riskLevel;
        riskLevel.textContent = riskScore;

        if (riskScore <= 20) {
            riskLevel.className = 'risk-indicator green';
            riskLevel.innerHTML = `<span class="risk-text">LOW RISK</span><span class="risk-percentage">${riskScore}%</span>`;
        } else if (riskScore <= 40) {
            riskLevel.className = 'risk-indicator yellow';
            riskLevel.innerHTML = `<span class="risk-text">MODERATE RISK</span><span class="risk-percentage">${riskScore}%</span>`;
        } else if (riskScore <= 70) {
            riskLevel.className = 'risk-indicator orange';
            riskLevel.innerHTML = `<span class="risk-text">HIGH RISK</span><span class="risk-percentage">${riskScore}%</span>`;
        } else {
            riskLevel.className = 'risk-indicator red';
            riskLevel.innerHTML = `<span class="risk-text">CRITICAL RISK</span><span class="risk-percentage">${riskScore}%</span>`;
        }

        // Display risk factors
        this.elements.riskFactors.innerHTML = factors
            .map(f => `<p class="factor-item">${f}</p>`)
            .join('');
    }

    /**
     * Generate crop-specific recommendations
     */
    generateRecommendations(weather) {
        const recommendations = [];
        const crop = state.currentFarm.cropType || 'general';

        if (weather.humidity > 75 && weather.temperature > 20) {
            recommendations.push({
                icon: 'üõ°Ô∏è',
                text: `High fungal disease risk detected. Apply fungicide preventively for ${crop}`,
                action: 'Schedule Spraying'
            });
        }

        if (weather.rainfall > 10) {
            recommendations.push({
                icon: 'üíß',
                text: 'Heavy rainfall detected. Ensure proper drainage to prevent waterlogging',
                action: 'Check Drainage'
            });
        }

        if (weather.wind_speed > 25) {
            recommendations.push({
                icon: 'üí®',
                text: 'Strong winds predicted. Stakes and supports should be checked',
                action: 'Inspect Stakes'
            });
        }

        if (weather.temperature < 5) {
            recommendations.push({
                icon: '‚ùÑÔ∏è',
                text: 'Frost risk detected. Protect sensitive crops',
                action: 'Apply Protection'
            });
        }

        // Render recommendations
        this.elements.recommendations.innerHTML = recommendations
            .map(rec => `
                <div class="recommendation-item">
                    <span class="action-icon">${rec.icon}</span>
                    <span class="action-text">${rec.text}</span>
                    <button class="btn btn-small">${rec.action}</button>
                </div>
            `).join('');
    }

    /**
     * Save alert configuration
     */
    saveAlertConfig() {
        const config = {
            highTempAlert: document.getElementById('highTempAlert')?.checked,
            highHumidityAlert: document.getElementById('highHumidityAlert')?.checked,
            rainAlert: document.getElementById('rainAlert')?.checked,
            frostAlert: document.getElementById('frostAlert')?.checked
        };

        localStorage.setItem('weatherAlertConfig', JSON.stringify(config));
        showAlert('Alert configuration saved!', 'success');
    }

    /**
     * Show weather section
     */
    show() {
        if (this.elements.section) {
            this.elements.section.style.display = 'block';
            this.loadWeatherData();
        }
    }

    /**
     * Hide weather section
     */
    hide() {
        if (this.elements.section) {
            this.elements.section.style.display = 'none';
        }
    }
}

// Initialize weather module when page loads
const weatherModule = new WeatherModule();
</script>
